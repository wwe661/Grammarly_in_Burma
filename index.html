<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      id="favicon"
      rel="icon"
      href="Logo&Pics/mainlogo.png"
      type="image/png"
    />
    <title>Grammarly In Burma</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="user">
    <header>
      <div class="logo-wrap">
        <span class="logo-text">Grammarly In Burma</span>
        <img
          id="logo"
          src="Logo&Pics/mainlogo.png"
          alt="Grammerly In Burma"
          class="logo-icon"
        />
      </div>
      <div class="mode-switch">
        <button id="userBtn" class="active" onclick="setMode('user')">
          User Mode
        </button>
        <button id="trainerBtn" onclick="setMode('trainer')">
          Trainer Mode
        </button>
      </div>
    </header>

    <div class="container">
      <!-- Input Panel -->
      <div class="panel">
        <textarea
          id="textInput"
          placeholder="မြန်မာစာကို ဒီမှာ ရိုက်ထည့်ပါ…"
        ></textarea>
        <div class="panel-footer">
          <button class="btn primary" onclick="checkText()">Submit</button>
          <button class="btn" onclick="pasteInput()">Paste</button>
          <button class="btn" onclick="clearInput()">Clear</button>
        </div>
      </div>

      <!-- Wall -->
      <div class="wall">
        <div class="particles"></div>
        <div class="credentials">
          <h3>Trainer Access</h3>
          <input type="text" id="trainerUser" placeholder="Username" />
          <input type="password" id="trainerPass" placeholder="Password" />
          <button
            class="btn primary"
            style="padding: 14px; font-size: 15px"
            onclick="trainerLogin()"
          >
            Unlock
          </button>
        </div>
      </div>

      <!-- Output Panel -->
      <div class="panel">
        <div id="result" class="output">Output will appear here…</div>
        <div class="panel-footer">
          <button class="btn primary" onclick="copyResult()">Copy</button>
          <button class="btn" onclick="downloadResult()">Download</button>
          <button class="btn" onclick="clearResult()">Reset</button>
        </div>
      </div>
    </div>

    <script>
      // function normalizeInput(text) {
      //   return text.normalize("NFC");
      // }

      function hasnonEscape(str) {
        // Tests if the single character is NOT a whitespace character.
        // return !/\s/.test(char);
        for (let i = 0; i < str.length; i++) {
          const char = str[i];
          if (!/\s/.test(char)) {
            return true; // Found a non-whitespace character
          }
        }
        // Alternatively, you could test for presence of a non-whitespace character:
        // return /\S/.test(char); // This works too for a single char.
      }
      async function checkText() {
        animateWall();
        const isDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;

        const text = document.getElementById("textInput").value;
        // const sourceText = normalizeInput(text);
        // console.log("Input text:", sourceText);
        // const segmenter = new Intl.Segmenter("my", { granularity: "grapheme" });

        // function toGraphemes(text) {
        //   return [...segmenter.segment(text)];
        // }

        // const graphemes = toGraphemes(sourceText);
        sending_mode = "trainer";
        const url = "http://127.0.0.1:8000/checkfrom" + sending_mode;
        console.log("Request URL:", url);
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });

        const data = await response.json();

        console.log("Flags received:", data.flags);
        const { normalized, flags } = data;

        let newtext = "";
        let lastIndex = 0;

        for (const flag of data.flags) {
          const { start, end, message, norm, status, color } = flag;

          // append untouched text
          // test = hasnonEscape(text.slice(lastIndex, start));
          // newtext +=
          //   sending_mode == "user"
          //     ? test
          //       ? ""
          //       : text.slice(lastIndex, start)
          //     : text.slice(lastIndex, start);
          newtext += `<span style="background:red">${normalized.slice(lastIndex, start)}</span>`;
          const segment = normalized.slice(start, end);
          console.log("Segment:", segment);
          console.log(start, end);
          _ = `<span class="underlined" style="text-decoration: underline ${color};">`;
          _ += `${segment}${message ? `<span class="message">${message}</span>` : ""}</span>`;

          newtext += sending_mode == "user" ? norm : _;

          lastIndex = end;
        }

        // append remaining text
        newtext += text.slice(lastIndex);

        // result.innerHTML = newtext;

        document.getElementById("result").innerHTML = newtext;
      }
    </script>
    <script src="script.js"></script>
  </body>
</html>
